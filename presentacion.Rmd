---
title: "Los verbos del Tidyverse"
output:
  slidy_presentation: default
  beamer_presentation: default
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = T, warning = F, error = F, message = F)
```

## El Tidyverse

- Colección de paquetes de `R` diseñdo para ciencia de datos.
- Todos los paquetes comparten la misma filosofía de diseño, gramática y estructuras de datos.
- Para tener la instalación completa: 

```{r, eval = F}
install.packages("tidyverse")

# Instalen tambien
install.packages("vcdExtra")
install.packages("nycflights13")
```

## El ciclo de análisis de datos

Wickham, H y Grolemund G. [*R for Data Science*](http://r4ds.had.co.nz/explore-intro.html)

![](img/ciclo.png)

## El ciclo en paquetes

![](img/ciclo_paquetes.png)

## El ciclo en paquetes (enfoque)

![](img/ciclo_paquetes_enfoque.png)

## Los verbos básicos en `dplyr`

![](img/verbos_basicos.png)

## Los verbos básicos en acción (saquen su compu)

```{r}
library(nycflights13)
library(vcdExtra)
library(tidyverse)
datasets("nycflights13")
flights
```

## filter

```{r}
filter(flights, month == 1, day == 1)
```

 `filter` permite comparaciones (`>, <, ==`), operadores lógicos (`|, &, !, %in%`), preguntar por perdidos (`is.na, is.NaN`)
 
**filter: ejercicios**
 
 Encuentra todos los vuelos que:
 
 - Se retrasan más de 2 horas
 - Salen en verano (Junio, Julio, Agosto)
 - Salen en invierno (Diciembre, Enero, Febrero)
 - ¿Son muy diferentes en -volúmen de vuelos- ambas estaciones?
 - ¿Cuántos vuelos tienen valores perdidos en `dep_time`?
 
## arrange

Arrange te permite ordenar un conjunto de datos según una o más variables en forma ascendente y descendiente.
 
```{r}
arrange(flights, year, month, day)
arrange(flights, desc(arr_delay))
```

**arrange: ejercicios**
 
¿Cuáles son los vuelos más cortos?
¿Cuáles son los más largos?

## select

Te permite seleccionar variables de distintas formas.

```{r}
select(flights, year, month, day)
select(flights, year:day)
select(flights, -(year:day))
```

`select` tiene funciones que te permiten aprovecharlo más:

- `starts_with("XXX")` trae todos los nombres que empiezan con "XXX"
- `ends_with("XXX")` trae todos los nombres que terminan con "XXX"
- `contains("XXX")` trae todos los nombres que tiene la cadena de caracteres "XXX"
- `matches("XXX")` trae todos los nombres que continen la cadena de caracteres "XXX"
- `num_range("x", 1:3)` trae "x1, x2, x3"

**select: ejercicios**

¿De cuántas maneras puedo llamar a las variables `dep_time`, `dep_delay`, `arr_time`, `arr_delay`

## mutate

Mutate te permite agregar nuevas variables que suelen ser funciones de otras columnas.

```{r, eval = F}
mutate(flights,
       velocidad = distance / air_time * 60
       )
```

*¿Qué hace esta operación?*

**mutate: ejercicios**

- Compara air_time contra (arr_time - dep_time). *Usa mutate para crear una variable con la resta, después selecciona las variables a comparar.*
  - ¿Qué esperabas encontrar?
  - ¿Hay algo que arreglar?


**Dato curioso**

Hay muchas funciones auxiliares dentro de  `dplyr` que te permiten aprovechar más al verbo `mutate`. Por ejemplo, tiene implementado varias funciones ventana:

![](img/window_functions.png)

Estas funciones son mucho más útiles en *grupos* (ahí viene).

Fuente: [Data wrangling cheatsheet](https://www.rstudio.com/wp-content/uploads/2015/02/data-wrangling-cheatsheet.pdf)

## summarise

Permite colapsar un data frame en una única fila "resumen"

```{r}
summarise(flights, delay = mean(dep_delay, na.rm = TRUE))
```

Igual que `mutate`, `summarize` es mucho más útil si se piensa en el contexto de grupos, para lo que nos sirve la función `group_by`.

```{r}
flights_agrupada <- group_by(flights, year, month, day)
class(flights_agrupada)
flights_agrupada
```

Ahora si, puedo generar resumenes útiles por día. Por ejemplo, el retraso promedio por día:

```{r}
summarise(flights_agrupada, delay = mean(dep_delay, na.rm = TRUE))
```

**Dato curioso**

También se encuentran implementadas funciones de agregaciones muy comunes:

![](img/agg_functions.PNG)

Fuente: [Data wrangling cheatsheet](https://www.rstudio.com/wp-content/uploads/2015/02/data-wrangling-cheatsheet.pdf)

## Los verbos y el group_by

![](img/verbos_agrupados.PNG)

## %>%

Un verbo solo no es demasiado útil. Lo poderoso de los verbos es utilizarlos en conjunto. Para ello, ayuda mucho utilizar el operador *pipe*.

Por ejemplo, puedo encontrar los peores días en retrasos.

```{r}
select(flights, 
  year:day, 
  ends_with("delay"), 
  distance, 
  air_time
) %>%
  mutate(
  gain = arr_delay - dep_delay,
  speed = distance / air_time * 60
) %>%
  group_by(year, month, day) %>%
  filter(rank(desc(arr_delay)) < 10)
```

o los destinos más populares

```{r}
flights %>% 
  group_by(dest) %>% 
  filter(n() > 365)
```


**%>%: ejercicios**

- ¿Cuál es la hora óptima para viajar para evitar retrasos?
- Encuentra todos los destinos que vuelan por más de una aerolínea. ¿Cuál es la mejor aerolínea en ese subgrupo?

## Joins

- ¿Qué pasa si lo que quiero es saber cómo se ven afectados los retrasos por el clima?
- ¿O como afecta el tipo de avión y su edad a la velocidad promedio?
- ¿O si hay aeropuertos que están muy saturados e, independientemente del clima o el destino, siempre tienen retrasos?

Para ello, debo juntar información de otras de las bases que están en el paquete nycflights13.

Recordemos las tablas en el paquete:

```{r}
datasets("nycflights13")
```

El modelo de relación de las tablas se ve como sigue:

![](img/modelo_relacional.PNG)

Aunque sale del scope por lo corto del taller, conviene saber que exixsten los *joins* en `dplyr`.

Podemos pensar en los joins que se realizan en SQL>

![](img/sql_joins.PNG)

Y entender cómo se traducen en dplyr:

![](img/dplyr_joins.PNG)

**joins: ejemplo**

Esto nos permite contestar preguntas aún más poderosas. Por ejemplo, podemos calcular el promedio de retrasos por destinos, juntar esa información con los datos de aeropuertos para dibujar la distribución espacial de los retrasos.

```{r}
airports %>%
  semi_join(flights, c("faa" = "dest")) %>%
  ggplot(aes(lon, lat)) +
    borders("state") +
    geom_point() +
    coord_quickmap()
```

Para más ejemplos como estos, revisa el capítulo de "[Relational data](http://r4ds.had.co.nz/relational-data.html)" en *R for data science*. 